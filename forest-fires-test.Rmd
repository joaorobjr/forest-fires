---
title: "Forest Fires in Portugal - What Are The Causes?"
subtitle: "Practical Assignment of Data Mining I"
author: "By Robson Teixeira, Eduardo Rodrigues and Claudio Rocha"
date: "M:CC -- FCUP, 10/01/2021"
output:
  pdf_document:
    #citation_package: natbib
    df_print: tibble
    fig_caption: yes
    fig_crop: no
    fig_height: 5
    fig_width: 7
    number_sections: yes
    toc: yes
  html_notebook: 
    code_folding: hide
    df_print: default
    number_sections: yes
    toc: yes
    toc_float: yes
  html_document:
    #df_print: paged
    code_folding: "hide"
    df_print: tibble
    fig_caption: yes
    includes:
      in_header: header.html
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
geometry:
- top=25mm
- bottom=25mm
- left=25mm
- right=20mm
- heightrounded
header-includes:
  \usepackage{caption}
  \usepackage{fancyhdr}
  \usepackage{lmodern}
  \usepackage[detect-all]{siunitx}
highlight-style: pygments
linkcolor: blue
mainfont: Source Variable Pro
fontsize: 12pt
sansfont: Source Sans Pro
documentclass: report
urlcolor: blue
references:
- type: article-journal   
  id: geosciences10020053
  title: Mapping the Causes of Forest Fires in Portugal by Clustering Analysis
  author:
    - family: Meira Castro
      given: Ana C.
    - family: Nunes
      given: Adélia 
    - family: Sousa
      given: António
    - family: Lourenço
      given: Luciano
  publisher: Geosciences
  issued:
    year: 2020
---

---


```{r setup, include= F}
knitr::opts_chunk$set(echo= T, warning= F, message= F)
require(tidyverse)
require(funModeling)
require(measurements)
require(lubridate)
require(ggplot2)
require(devtools)
require(mlbench)
require(caret)
require(performanceEstimation)
require(e1071)
require(nnet)
require(neuralnet)
require(naivebayes)
require(rpart.plot)

# turns off scientific notation; to turn it back on, use scipen= 0
options(scipen= 999)
```



# Abstract {-}

# Introduction

In this project, we try to find the best machine learning model that more accurately predicts whether a forest fire occurs negligently, intentionally, naturally or recurrently. From a database that was given to us, we divided the work into several parts. First, we analyzed the database according to the variables it contained ....

# Problem Definition

Forest fires are a very important issue that negatively affects climate change. Typically, the causes of forest fires are those oversights, accidents and negligence committed by individuals, intentional acts and natural causes. The latter is the root cause for only a minority of the fires.

Their harmful impacts and effects on ecosystems can be major ones. Among them, we can mention the disappearance of native species, the increase in levels of carbon dioxide in the atmosphere, earth’s nutrients destroyed by the ashes, and the massive loss of wildlife.

Data mining techniques can help in the prediction of the cause of the fire and, thus, better support the decision of taking preventive measures in order to avoid tragedy. In effect, this can play a major role in resource allocation, mitigation and recovery efforts.

# Forest Fire Dataset

The ICFN - Nature and Forest Conservation Institute has the record of the list of forest fires occurred in Portugal for several years. For each fire, there is information such as the site, the alert date/hour, the extinction date/hour, the affected area and the cause type. A classifications for causes types are presented in table \@ref(tab:cause_type).

Table 1: (\#tab:cause_type) Classifications of causes of forest fires.

Cause       |Description                                           
------------|---------------------------------------------------------------------------------------------
Unknown     | absence of suficient objective evidence to determine the cause of the ignition of fire
Natural     | lightning generated in thunderstorms
Negligence  | the misguided use of fire in activities such as burning trash, mass burning of agricultural and forest fuels, fun and leisure activities; failure to properly extinguish cigarettes by smokers; the dispersal and transport of incandescent particles from chimneys; etc.
Intentional | incendiarism and arson, mostly resulting from behaviors and attitudes reacting to theconstraints of agroforestry management systems and to conflicts related to land use
Rekindling  | reburning of an area over which a fire has previously passed, but where fuel has been left that is later ignited by latent heat, sparks, or embers


```{r data, echo= F, error= F}
fires.train.path = file("data/fires2015_train.csv")
fires.test.path = file("data/fires2015_test.csv")

fires.raw = as_tibble(read.csv("data/fires2015_train.csv",
                               stringsAsFactors = FALSE, 
                               na.strings = c("-", "","NA"), 
                               encoding = "UTF-8"))

#fires.test.raw <- read.csv(fires.test.path, stringsAsFactors = FALSE, 
#                           na.strings = c("-", "","NA"), 
#                           encoding = "UTF-8")

```


The dataset used in this study was provided by ICFN, and it contains the data on reported forest fires during 2015 and its respective causes. The data are distributed in files:

* **fires2015train.csv** --- the file contain the data of 7511 reported forest fires during 2015

A summary of the structure of it and a glimpse of their first rows are provided below.
```{r fires.raw-summary, echo = F}
glimpse(fires.raw)
head(fires.raw)
df_status(fires.raw)
tail(fires.raw)
```

## Dataset Variables

Table \@ref(tab:variables) describes all variables contained in the `fires.raw` of the data set.
Clearly, the type of some of variables is incorrect and inconvenient for analysis and that was taken care of in section \@ref(data-cleaning).

Table: (\#tab:variables) List of variables present in the original file from the fires2015train.csv data set.

Variable          |Type        |Description                   |
------------------|------------|------------------------------|------
id                |integer     |id number                     |
region            |character   |region name                   |
district          |character   |district name                 |
municipality      |character   |municipality name             |
parish            |character   |parish name                   |
lat               |character   |latitude value                |
lon               |character   |longitude value               |
origin            |character   |how the fire started          |
alert_date        |character   |date when fire started        |
alert_hour        |character   |alert hour                    |
extinction_date   |character   |date of the end of fire       |
extinction hour   |character   |hour of the end of fire       |
firstInterv_date  |character   |date of intervention          |
firstInterv_hour  |character   |hour of intervention          |
alert_source      |logical     |alert source                  |
village_area      |numeric     |village area affected         |
alert_source      |logical     |alert source                  |
village_area      |numeric     |village area affected         |
vegetation_area   |numeric     |vegetation area affected      |
farming_area      |numeric     |farming area affected         |
village_veget_area|numeric     |total village+veget affected  |
total_area        |numeric     |total area affected           |
cause_type        |character   |cause of the fire             |


## Graphic analysis


1- Bar plot of forests fires during 2015

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = month(alert_date, label = T))) +
  geom_bar(fill = "red") +
  ggtitle("Distribution of forests fires across 2015") +
  labs(x="Months", y="Total")
```

Conclusion: july and august were the months with a great number of ocurrences


2- Bar plot of forests fires during 2015 by region

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = region)) +  theme(axis.text.x = element_text(angle = 90)) + geom_bar() + ggtitle("Distribution of forests fires by region") +
  labs(x="Region", y="Total")
```

Conclusion: Entre Douro e Minho was the region with mores forests fires


3- Bar plot of forests fires during 2015 by district

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = district)) +  theme(axis.text.x = element_text(angle = 90))+geom_bar() + ggtitle("Distribution of forests fires by district") +
  labs(x="District", y="Total")
```


Conclusion: Porto was the district with more forests fires


4- Bar plot of forests fires during 2015 by causes

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = cause_type)) + geom_bar(color = "black", fill = "light blue") + ggtitle("Distribution of causes of fires")+
  labs(x="Causes of Fires", y="Total")
```


Conclusion: negligence was the big cause of the forests fires


5- Bar plot of forests fires during 2015 by origin

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = origin)) + geom_bar(fill = "blue") + ggtitle("Distribution of forests fires by origin across 2015")+
  labs(x="Origin", y="Total")
```


Conclusion: firepit was the origin of the most forests fires


6- Relationship between district, month and causes

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = district, y = month(alert_date, label = T))) +  theme(axis.text.x = element_text(angle = 90)) + geom_point(aes(color = cause_type)) + ggtitle("Relationship between district, month and cause_type")+
  labs(x="District", y="Months")
```


7- Relationship between region, month and causes

```{r echo = FALSE, fig.align= "center"}
ggplot(fires.raw, aes(x = region, y = month(alert_date, label = T))) +  theme(axis.text.x = element_text(angle = 90)) + geom_point(aes(color = cause_type)) + ggtitle("Relationship between region and month") + labs(x="Region", y="Months")
```

# Data Preparation

## Data Cleaning and Transforms: 
We started to verify the dataset to identify and correct the mistakes and errors in the data.
First we tested if there were duplicated observations.
```{r echo=FALSE}
anyDuplicated(fires.raw)
```
The result was negative.

The lat variable had to be corrected because we observed that incorrect values like a date were mixed in it.
```{r echo=FALSE}
idx.lat.wrong = which(str_detect(fires.raw$lat, '1900-01-01'))
lat.wrong = fires.raw[idx.lat.wrong,]
#head(select(lat.wrong$lat, lat.wrong$lon))
```

The number of observations with wrong value in lat variable were detected and the total number of them is showed below.
```{r echo=FALSE}
print(str_c("There are",length(idx.lat.wrong),"observations with wrong value '1900-01-01'", sep = " "))
```

On the wrong values, an imputation was made, based on another observation that has the same region, district, municipality and parish than these.
```{r echo=FALSE}
for (idx in idx.lat.wrong) {
  df_temp = fires.raw[-idx.lat.wrong,] %>% 
    filter(region == fires.raw[idx,]$region, 
           district == fires.raw[idx,]$district,
           municipality ==fires.raw[idx,]$municipality,
           parish == fires.raw[idx,]$parish)
  fires.raw$lat[idx] = df_temp$lat[1]
  fires.raw$lon[idx] = df_temp$lon[1]
}
rm(df_temp)
```

A cleaning was made on lat and lon variables to remove some characters and change to "". This process was necessary to convert their contents from GPS coordinate to decimals.
```{r echo=FALSE}
vec_clean <- c("''"="", "E-12"="", "E-11"="", "E-02"="", ","=".", "º"=" ", "'"=" ", ":"=" ")
fires.raw$lat <- conv_unit(str_replace_all(str_trim(fires.raw$lat), vec_clean), "deg_min_sec", "dec_deg")
```

An warning occurred when this line was executed.
```{r echo=FALSE}
fires.raw$lon <- conv_unit(str_replace_all(str_trim(fires.raw$lon, side = "both"), vec_clean), "deg_min_sec", "dec_deg")
# Workaround
fires.raw$lon[7511] <- conv_unit("8 34 21.5868000000013", "deg_min_sec", "dec_deg")
```
After the imputation, 8 NA´s values were assigned to observations in latitude and longitude variables

Insert latitude and longitude for parish with missing values
```{r echo=FALSE}
idx.latlon.na = which(is.na(fires.raw$lat) & is.na(fires.raw$lon))
latlon.na = fires.raw[idx.latlon.na,]
#head(select(latlon.na$parish, latlon.na$lat, latlon.na$lon))
```
Alentejo - Évora - Mora - Cabeção
```{r echo=FALSE}
fires.raw$lat[439] = 38.954167
fires.raw$lon[439] = -8.072778
```

Alentejo -	Évora - Montemor-o-Novo - Cortiçadas de Lavre
```{r echo=FALSE}
fires.raw$lat[1722] = 38.786577
fires.raw$lon[1722] = -8.432094
```

Alentejo - Évora - Montemor-o-Novo - Ciborro
```{r echo=FALSE}
fires.raw$lat[2633] = 38.800833
fires.raw$lon[2633] = -8.228056
```

Alentejo -	Évora -	Mourão - Granja
```{r echo=FALSE}
fires.raw$lat[3007] = 38.3 
fires.raw$lon[3007] = -7.255
```

Alentejo -	Évora -	Évora	- Horta das Figueiras
```{r echo=FALSE}
fires.raw$lat[3443] = 38.545
fires.raw$lon[3443] = -7.905556
```

Alentejo -	Évora - Montemor-o-Novo - Cortiçadas de Lavre
```{r echo=FALSE}
fires.raw$lat[3586] = 38.786577
fires.raw$lon[3586] = -8.432094
```

Alentejo - Évora - Estremoz - São Lourenço de Mamporcão	
```{r echo=FALSE}
fires.raw$lat[5284] = 38.890833
fires.raw$lon[5284] = -7.545833
```

Alentejo - Évora - Mora - Brotas
```{r echo=FALSE}
fires.raw$lat[7228] = 38.873056
fires.raw$lon[7228] = -8.15
```

Data imputation: firstInterv_date and firstInterv_hour
```{r echo=FALSE}
fires.raw <- fires.raw %>% rowwise() %>% mutate(firstInterv_date = if_else( is.na(firstInterv_date) && !is.na(extinction_date), extinction_date , firstInterv_date),
                                                firstInterv_hour = if_else( is.na(firstInterv_hour) && !is.na(extinction_hour), extinction_hour , firstInterv_hour))
```

Changing type of some variables to factor 
```{r echo=FALSE}
fires.raw$region = as.factor(fires.raw$region)
fires.raw$district = as.factor(fires.raw$district)
fires.raw$municipality = as.factor(fires.raw$municipality)
fires.raw$parish = as.factor(fires.raw$parish)
fires.raw$origin = as.factor(fires.raw$origin)
fires.raw$cause_type = as.factor(fires.raw$cause_type)
```

Creating new features

Variable alert 
```{r echo=FALSE}
fires.raw <- fires.raw %>% rowwise() %>% 
  mutate(alert = ymd_hms(str_c(alert_date, alert_hour, sep=" ")),
         extinction = ymd_hms(str_c(extinction_date, extinction_hour, sep=" ")),
         firstInterv = ymd_hms(str_c(firstInterv_date, firstInterv_hour, sep=" ")),
         latency_alert_interv = (firstInterv - alert)/60,
         latency_interv_ext = (extinction - firstInterv)/60,
         latency_alert_ext = (extinction - alert)/60)

fires.raw <- as_tibble(fires.raw)
df_status(fires.raw)
```

Marking a check point
```{r echo=FALSE}
#save(fires.raw, file = "fires.raw.RData")
load("fires.raw.RData")
```

----------------------------------XXXXXXXXXXXXXXXXXX----------------------



Creating new features
Variable alert 
```{r echo=FALSE}
fires.raw <- fires.raw %>% rowwise() %>% 
  mutate(alert = ymd_hms(str_c(alert_date, alert_hour, sep=" ")),
         extinction = ymd_hms(str_c(extinction_date, extinction_hour, sep=" ")),
         firstInterv = ymd_hms(str_c(firstInterv_date, firstInterv_hour, sep=" ")),
         latency_alert_interv = (firstInterv - alert)/60,
         latency_interv_ext = (extinction - firstInterv)/60,
         latency_alert_ext = (extinction - alert)/60)

fires.raw <- as_tibble(fires.raw)
df_status(fires.raw)
```

-------------save(fires.raw, file = "fires.raw.RData")-----
```{r echo=FALSE}
load("fires.raw.RData")
```


## Feature Engineering
Deriving new variables from available data and merging datasets WEATHER DATA AND FOREST FIRES getting new variables that can help on the predictions.
We insert some new variables like TAVG, TMIN, TMAX and PRCP and did an imputation of value in tavg variable based on tmax and tmin,
in tavg variable based on tavg15d (15 days before each occurrence), in tavg15d variable if NaN, in tmax variable based on tavg and tmin, in tmin variable based on tavg and tmax. We eliminated the maximum of observations with zeros and the dataset stayed like below:

```{r echo=FALSE}
load("data/station_data.Rdata")

#INSERIR MERGE DOS DATASETS ------------ xxxxxxxx --------------

load("ffires.RData")

df_status(ffires)

```

### Feature Selection

Identifying those input variables that are most relevant to the task.
First, we rename the dataset and extracted some variables to minimize it.
The variables "parish" and "municipality" have many diferent observations,
"id" can be retired because it is only the number of the lines of dataset and we don´t need this column, "region" has 501 NA´s and we don´t have how to substitute them, "alert_source" only has NA´s and it can be removed.
```{r echo = FALSE}
ffires.rf = ffires
ffires.rf = ffires.rf %>% select(-id, -region, -municipality, -parish, -alert_source, -alert_date, -alert_hour, -firstInterv_date, -firstInterv_hour, -extinction_date, -extinction_hour)
ffires.rf = ffires.rf %>% filter(!is.na(extinction))
ffires.rf = ffires.rf %>% filter(!is.na(firstInterv))
```

We changed variables to numeric.
```{r echo = FALSE}
ffires.rf$lat = as.numeric(ffires.rf$lat)
ffires.rf$lon = as.numeric(ffires.rf$lon)
ffires.rf$latency_alert_ext = as.numeric(ffires.rf$latency_alert_ext)
ffires.rf$latency_alert_interv = as.numeric(ffires.rf$latency_alert_interv)
ffires.rf$latency_interv_ext = as.numeric(ffires.rf$latency_interv_ext)
df_status(ffires.rf)
```
