---
title: "Forest Fires in Portugal - What Are The Causes?"
author: "By Robson Teixeira, Eduardo Rodrigues and Claudio Rocha"
date: "M:CC -- FCUP, 10/01/2021"
output:
  bookdown::pdf_document2:
    df_print: tibble
    fig_caption: yes
    fig_crop: no
    fig_height: 5
    fig_width: 7
    number_sections: yes
    toc: yes
  bookdown::html_document2:
    code_folding: hide
    df_print: tibble
    fig_caption: yes
    includes:
      in_header: header.html
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
  html_notebook:
    code_folding: hide
    df_print: default
    number_sections: yes
    toc: yes
    toc_float: yes
subtitle: Practical Assignment of Data Mining I
geometry:
- top=25mm
- bottom=25mm
- left=25mm
- right=20mm
- heightrounded
header-includes: \usepackage{caption} \usepackage{fancyhdr} \usepackage{lmodern} \usepackage[detect-all]{siunitx}
highlight-style: pygments
linkcolor: blue
mainfont: Source Variable Pro
fontsize: 12pt
sansfont: Source Sans Pro
documentclass: report
urlcolor: blue
references:
- type: article-journal
  id: geosciences10020053
  title: Mapping the Causes of Forest Fires in Portugal by Clustering Analysis
  author:
  - family: Meira Castro
    given: Ana C.
  - family: Nunes
    given: Adélia
  - family: Sousa
    given: António
  - family: Lourenço
    given: Luciano
  publisher: Geosciences
  issued:
    year: 2020
---

---


```{r setup, include= F}
knitr::opts_chunk$set(echo= T, warning= F, message= F)
require(tidyverse)
require(funModeling)
require(measurements)
require(lubridate)
require(ggplot2)
require(devtools)
require(caret)
require(Boruta)
require(nnet)
require(pROC)
require(rpart)
require(rpart.plot)
# turns off scientific notation; to turn it back on, use scipen= 0
options(scipen= 999)
```




# Introduction

In this project, we try to find the best machine learning model that more accurately predicts whether a forest fire occurs negligently, intentionally, naturally or recurrently. From a database that was given to us, we divided the work into several parts.

The remainder of this report is organized as follows: in chapter 2, we describe the importance of predicting forest fires that are a big problem actually; in chapter 3 is described the causes ofnthe ocurrences that is the variable that the model will be predict and a table with all the variables of  the original dataset; chapter 4 is dedicated to the exploration, cleaning and engineering of the data. Some graphics are plotted in this chapter and they help to visualize the origins and locations of the forest fires; the models used to test the dataset are described and compared in chapter 5; in chapter 6, We finalize with the main conclusions and the last chapter includes references.


# Problem Definition

Forest fires are a very important issue that negatively affects climate change. Typically, the causes of forest fires are those oversights, accidents and negligence committed by individuals, intentional acts and natural causes. The latter is the root cause for only a minority of the fires.

Their harmful impacts and effects on ecosystems can be major ones. Among them, we can mention the disappearance of native species, the increase in levels of carbon dioxide in the atmosphere, earth’s nutrients destroyed by the ashes, and the massive loss of wildlife.

Data mining techniques can help in the prediction of the cause of the fire and, thus, better support the decision of taking preventive measures in order to avoid tragedy. In effect, this can play a major role in resource allocation, mitigation and recovery efforts.

# Forest Fire Dataset

The ICFN - Nature and Forest Conservation Institute has the record of the list of forest fires occurred in Portugal for several years. For each fire, there is information such as the site, the alert date/hour, the extinction date/hour, the affected area and the cause type. A classifications for causes types are presented in table \@ref(tab:cause_type).

Table 1: (\#tab:cause_type) Classifications of causes of forest fires.

Cause       |Description                                           
------------|---------------------------------------------------------------------------------------------
Unknown     | absence of suficient objective evidence to determine the cause of the ignition of fire
Natural     | lightning generated in thunderstorms
Negligence  | the misguided use of fire in activities such as burning trash, mass burning of agricultural and forest fuels, fun and leisure activities; failure to properly extinguish cigarettes by smokers; the dispersal and transport of incandescent particles from chimneys; etc.
Intentional | incendiarism and arson, mostly resulting from behaviors and attitudes reacting to theconstraints of agroforestry management systems and to conflicts related to land use
Rekindling  | reburning of an area over which a fire has previously passed, but where fuel has been left that is later ignited by latent heat, sparks, or embers


```{r data, echo= F, error= F}
fires.train.path = file("data/fires2015_train.csv")
fires.test.path = file("data/fires2015_test.csv")

fires.raw = as_tibble(read.csv("data/fires2015_train.csv",
                               stringsAsFactors = FALSE, 
                               na.strings = c("-", "","NA"), 
                               encoding = "UTF-8"))
```


The dataset used in this study was provided by ICFN, and it contains the data on reported forest fires during 2015 and its respective causes. The data are distributed in files:

* **fires2015train.csv** --- the file contain the data of 7511 reported forest fires during 2015

A summary of the structure of the dataset is provided below.
```{r fires.raw-summary, echo = F}
glimpse(fires.raw)
head(fires.raw)
df_status(fires.raw)
tail(fires.raw)
```

## Dataset Variables

Table \@ref(tab:variables) describes all variables contained in the `fires.raw` of the data set.
Clearly, the type of some of variables is incorrect and inconvenient for analysis and that was taken care of in section \@ref(data-cleaning).

Table: (\#tab:variables) List of variables present in the original file from the fires2015train.csv data set.

Variable          |Type        |Description                   |
------------------|------------|------------------------------|------
id                |integer     |id number                     |
region            |character   |region name                   |
district          |character   |district name                 |
municipality      |character   |municipality name             |
parish            |character   |parish name                   |
lat               |character   |latitude value                |
lon               |character   |longitude value               |
origin            |character   |how the fire started          |
alert_date        |character   |date when fire started        |
alert_hour        |character   |alert hour                    |
extinction_date   |character   |date of the end of fire       |
extinction hour   |character   |hour of the end of fire       |
firstInterv_date  |character   |date of intervention          |
firstInterv_hour  |character   |hour of intervention          |
alert_source      |logical     |alert source                  |
village_area      |numeric     |village area affected         |
alert_source      |logical     |alert source                  |
village_area      |numeric     |village area affected         |
vegetation_area   |numeric     |vegetation area affected      |
farming_area      |numeric     |farming area affected         |
village_veget_area|numeric     |total village+veget affected  |
total_area        |numeric     |total area affected           |
cause_type        |character   |cause of the fire             |


# Exploratory data analysis and engineering

## Data Cleaning and Transforms: 
We started to verify the dataset to identify and correct the mistakes and errors in the data.
First we tested if there were duplicated observations.
```{r echo=FALSE}
anyDuplicated(fires.raw)
```
The result was negative.

The lat variable had to be corrected because we observed that incorrect values like a date were mixed in it.
```{r echo=FALSE}
idx.lat.wrong = which(str_detect(fires.raw$lat, '1900-01-01'))
lat.wrong = fires.raw[idx.lat.wrong,]
#head(select(lat.wrong$lat, lat.wrong$lon))
```

The number of observations with wrong value in lat variable were detected and the total number of them is showed below.
```{r echo=FALSE}
print(str_c("There are",length(idx.lat.wrong),"observations with wrong value '1900-01-01'", sep = " "))
```

On the wrong values, an imputation was made, based on another observation that has the same region, district, municipality and parish than these.
```{r echo=FALSE}
for (idx in idx.lat.wrong) {
  df_temp = fires.raw[-idx.lat.wrong,] %>% 
    filter(region == fires.raw[idx,]$region, 
           district == fires.raw[idx,]$district,
           municipality ==fires.raw[idx,]$municipality,
           parish == fires.raw[idx,]$parish)
  fires.raw$lat[idx] = df_temp$lat[1]
  fires.raw$lon[idx] = df_temp$lon[1]
}
rm(df_temp)
```

A cleaning was made on lat and lon variables to remove some characters and change to "". This process was necessary to convert their contents from GPS coordinate to decimals.
```{r echo=FALSE}
vec_clean <- c("''"="", "E-12"="", "E-11"="", "E-02"="", ","=".", "º"=" ", "'"=" ", ":"=" ")
fires.raw$lat <- conv_unit(str_replace_all(str_trim(fires.raw$lat), vec_clean), "deg_min_sec", "dec_deg")
```


```{r echo=FALSE}
fires.raw$lon <- conv_unit(str_replace_all(str_trim(fires.raw$lon, side = "both"), vec_clean), "deg_min_sec", "dec_deg")
# Workaround
fires.raw$lon[7511] <- conv_unit("8 34 21.5868000000013", "deg_min_sec", "dec_deg")
```
After the imputation, 8 NA´s values were assigned to observations in latitude and longitude variables

For parish with missing values we insert latitude and longitude 
```{r echo=FALSE}
idx.latlon.na = which(is.na(fires.raw$lat) & is.na(fires.raw$lon))
latlon.na = fires.raw[idx.latlon.na,]
#head(select(latlon.na$parish, latlon.na$lat, latlon.na$lon))
```
Alentejo - Évora - Mora - Cabeção
```{r echo=FALSE}
fires.raw$lat[439] = 38.954167
fires.raw$lon[439] = -8.072778
```

Alentejo -	Évora - Montemor-o-Novo - Cortiçadas de Lavre
```{r echo=FALSE}
fires.raw$lat[1722] = 38.786577
fires.raw$lon[1722] = -8.432094
```

Alentejo - Évora - Montemor-o-Novo - Ciborro
```{r echo=FALSE}
fires.raw$lat[2633] = 38.800833
fires.raw$lon[2633] = -8.228056
```

Alentejo -	Évora -	Mourão - Granja
```{r echo=FALSE}
fires.raw$lat[3007] = 38.3 
fires.raw$lon[3007] = -7.255
```

Alentejo -	Évora -	Évora	- Horta das Figueiras
```{r echo=FALSE}
fires.raw$lat[3443] = 38.545
fires.raw$lon[3443] = -7.905556
```

Alentejo -	Évora - Montemor-o-Novo - Cortiçadas de Lavre
```{r echo=FALSE}
fires.raw$lat[3586] = 38.786577
fires.raw$lon[3586] = -8.432094
```

Alentejo - Évora - Estremoz - São Lourenço de Mamporcão	
```{r echo=FALSE}
fires.raw$lat[5284] = 38.890833
fires.raw$lon[5284] = -7.545833
```

Alentejo - Évora - Mora - Brotas
```{r echo=FALSE}
fires.raw$lat[7228] = 38.873056
fires.raw$lon[7228] = -8.15
```

Data imputation: firstInterv_date and firstInterv_hour
```{r echo=FALSE}
fires.raw <- fires.raw %>% rowwise() %>% mutate(firstInterv_date = if_else( is.na(firstInterv_date) && !is.na(extinction_date), extinction_date , firstInterv_date),
                                                firstInterv_hour = if_else( is.na(firstInterv_hour) && !is.na(extinction_hour), extinction_hour , firstInterv_hour))
```

Changing type of some variables to factor 
```{r echo=FALSE}
fires.raw$region = as.factor(fires.raw$region)
fires.raw$district = as.factor(fires.raw$district)
fires.raw$municipality = as.factor(fires.raw$municipality)
fires.raw$parish = as.factor(fires.raw$parish)
fires.raw$origin = as.factor(fires.raw$origin)
fires.raw$cause_type = as.factor(fires.raw$cause_type)
```

We create new features using the alerts that can be used on the analisys.

```{r echo=FALSE}

load("fires.raw.RData")
df_status(fires.raw)
```

----------------------------------XXXXXXXXXXXXXXXXXX----------------------


## Statistical exploration of the variables



## Feature Engineering
Deriving new variables from available data and merging datasets WEATHER DATA AND FOREST FIRES getting new variables that can help on the predictions.
We insert some new variables like TAVG, TMIN, TMAX and PRCP and did an imputation of value in tavg variable based on tmax and tmin,
in tavg variable based on tavg15d (15 days before each occurrence), in tavg15d variable if NaN, in tmax variable based on tavg and tmin, in tmin variable based on tavg and tmax. We eliminated the maximum of observations with zeros and the dataset stayed like below:

```{r echo=FALSE}
load("data/station_data.Rdata")

#INSERIR MERGE DOS DATASETS ------------ xxxxxxxx --------------

load("ffires.RData")

df_status(ffires)

```


## Data exploration

```{r echo = FALSE}
load("ffiresFull.RData")

```


Based on the dataset we ploted some graphics that helped us to get some conclusions and showed a general notion about the problem of the forests fires.

Figure \@ref(fig:month-ratings) depicts the bar graphic of the distribution of forests fires during 2015. The x-axis represents the months along the year 0f 2015 and the y-axis represents the total of fires that occurred by month.

```{r month-ratings, echo = FALSE, fig.align= "center", fig.cap= "\\label{month-ratings}Barplot of the distribution of forests fires during 2015."}
ggplot(fires.raw, aes(x = month(alert_date, label = T))) +
  geom_bar(fill = "red") +
  ggtitle("Distribution of forests fires across 2015") +
  labs(x="Months", y="Total")
```

This graphic showed us that july and august are the months with the largest ocurrences and the period between march and september needs more atention. Probably we will consider the variable month as important to the analisys.

In another graphic, figure \@ref(fig:region-ratings) we plotted the bar graphic of the distribution of forests fires by region. The x-axis represents the regions and the y-axis represents the total of fires that occurred by region.

```{r region-ratings, echo = FALSE, fig.align= "center", fig.cap= "\\label{region-ratings}Barplot of the distribution of forests fires by regions."}
ggplot(fires.raw, aes(x = region)) +  theme(axis.text.x = element_text(angle = 90)) + geom_bar() + ggtitle("Distribution of forests fires by region") +
  labs(x="Region", y="Total")
```

Observing this grafic we saw that Entre Douro e Minho was the region with more forests fires and other regions like Centro, Lisboa and Norte were with minimum occurrences.


Another important graphic is the figure \@ref(fig:district-ratings) that corresponds to the distribution of forests fires by district. The x-axis represents the districts and the y-axis represents the total of fires that occurred by region.

```{r district-ratings, echo = FALSE, fig.align= "center", fig.cap= "\\label{district-ratings}Barplot of the distribution of forests fires by districts."}
ggplot(fires.raw, aes(x = district)) +  theme(axis.text.x = element_text(angle = 90))+geom_bar() + ggtitle("Distribution of forests fires by district") +
  labs(x="District", y="Total")
```

This graphic indicates that Porto and Viana do Castelo were the districts with more forests fires.


A bar plot of forests fires related with the causes of them, is being reported on figure \@ref(fig:causes-ratings). On the x-axis are listed the diferent causes and on y-axis represents the total of fires that occurred.

```{r causes-ratings,echo = FALSE, fig.align= "center", fig.cap= "\\label{causes-ratings}Barplot of the distribution of forests fires by causes."}
ggplot(fires.raw, aes(x = cause_type)) + geom_bar(color = "black", fill = "light blue") + ggtitle("Distribution of causes of fires")+
  labs(x="Causes of Fires", y="Total")
```

A thing that calls our atention is the difference between the number of fires that were caused by negligence and by natural causes. The number of forest fires caused intentionally were almost the half of the negligent causes  what is an alarmant number.

We plotted too a bar plot of forests fires during 2015 by origin, figure \@ref(fig:origin-ratings).On the x-axis are listed the diferent origins and on y-axis represents the total of fires that occurred.

```{r origin-ratings, echo = FALSE, fig.align= "center", fig.cap= "\\label{origin-ratings}Barplot of the distribution of forests fires by origins."}
ggplot(fires.raw, aes(x = origin)) + geom_bar(fill = "blue") + ggtitle("Distribution of forests fires by origin across 2015")+
  labs(x="Origin", y="Total")
```

The firepit was the origin of the most forests fires comparing it with the other origins.


The relationship between district, month and causes is represented on figure \@ref(fig:dismoncau-ratings). The x-axis includes the diferent districts, y-axis represents the months of ocurrences and the variable cause is showed by colours listed on the labels.

```{r dismoncau-ratings, echo = FALSE, fig.align= "center", fig.cap= "\\label{dismoncau-ratings}Distribution of forests fires relating district, month and causes."}
ggplot(fires.raw, aes(x = district, y = month(alert_date, label = T))) +  theme(axis.text.x = element_text(angle = 90)) + geom_point(aes(color = cause_type)) + ggtitle("Relationship between district, month and cause_type")+
  labs(x="District", y="Months")
```

The relationship between region, month and causes is represented on figure \@ref(fig:regmoncau-ratings). The x-axis includes the diferent regions, y-axis represents the months of ocurrences and the variable cause is showed by colours listed on the labels.

```{r regmoncau-ratings,echo = FALSE, fig.align= "center", fig.cap= "\\label{regmoncau-ratings}Distribution of forests fires relating region, month and causes."}
ggplot(fires.raw, aes(x = region, y = month(alert_date, label = T))) +  theme(axis.text.x = element_text(angle = 90)) + geom_point(aes(color = cause_type)) + ggtitle("Relationship between region and month") + labs(x="Region", y="Months")
```

## Feature Selection

# Models

## Evaluation of the models used

# Conclusions and Prospects

# References
